{"version":3,"file":"hds-aria-described-by.js","sources":["../../src/utils/hds-aria-described-by.ts"],"sourcesContent":["/**\n * Copyright (c) HashiCorp, Inc.\n * SPDX-License-Identifier: MPL-2.0\n */\n\nimport { tracked } from '@glimmer/tracking';\nimport { scheduleOnce } from '@ember/runloop';\nimport type Component from '@glimmer/component';\nimport type { HdsFormFieldSignature } from '../components/hds/form/field/';\nimport type { HdsFormFieldsetSignature } from '../components/hds/form/fieldset/';\nimport type { HdsFormKeyValueInputsFieldSignature } from '../components/hds/form/key-value-inputs/field';\nimport type { HdsFormKeyValueInputsSignature } from '../components/hds/form/key-value-inputs/index';\n\ntype ElementSet = Set<HTMLElement>;\n\nclass AriaDescriptorMap {\n  private _elements = new WeakMap<AriaDescribedByComponent, ElementSet>();\n\n  register(obj: AriaDescribedByComponent, element: HTMLElement): void {\n    const elements = this.findOrCreateElementSet(obj);\n    elements.add(element);\n  }\n\n  unregister(obj: AriaDescribedByComponent, element: HTMLElement): void {\n    const elements = this.findOrCreateElementSet(obj);\n    elements.delete(element);\n  }\n\n  entries(obj: AriaDescribedByComponent): HTMLElement[] {\n    const elements = this.findOrCreateElementSet(obj);\n    return Array.from(elements.values());\n  }\n\n  private findOrCreateElementSet(obj: AriaDescribedByComponent): ElementSet {\n    if (this._elements.has(obj)) {\n      return this._elements.get(obj) as ElementSet;\n    }\n\n    const elements: ElementSet = new Set();\n    this._elements.set(obj, elements);\n    return elements;\n  }\n}\n\nconst ariaDescriptorMap = new AriaDescriptorMap();\n\ntype AriaDescribedByArgs =\n  | HdsFormFieldSignature\n  | HdsFormFieldsetSignature\n  | HdsFormKeyValueInputsFieldSignature\n  | HdsFormKeyValueInputsSignature;\n\nexport interface AriaDescribedByComponent\n  extends Component<AriaDescribedByArgs> {\n  __ARIA_DESCRIPTION_IDS__?: string[];\n  ariaDescribedBy?: string;\n}\n\n// essentially a type that says we return a subclass of the given type T\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\ntype ClassOf<T> = new (owner: unknown, ...args: any[]) => T;\n\nexport function ariaDescribedBy(\n  BaseComponent: ClassOf<AriaDescribedByComponent>\n): ClassOf<AriaDescribedByComponent> {\n  class EnhancedComponent extends BaseComponent {\n    @tracked __ARIA_DESCRIPTION_IDS__: string[] = [];\n\n    get ariaDescribedBy(): string {\n      let descriptors = this.__ARIA_DESCRIPTION_IDS__;\n\n      if (this.args.extraAriaDescribedBy) {\n        descriptors = descriptors.concat(this.args.extraAriaDescribedBy);\n      }\n\n      return descriptors.join(' ');\n    }\n  }\n  return EnhancedComponent;\n}\n\nfunction synchronizeDescriptors(component: AriaDescribedByComponent): void {\n  if (component.isDestroying || component.isDestroyed) return;\n  const descriptors = ariaDescriptorMap.entries(component);\n  component.__ARIA_DESCRIPTION_IDS__ = descriptors.map(\n    (element): string => element.id\n  );\n}\n\nexport function registerAriaDescriptionElement(\n  component: AriaDescribedByComponent,\n  element: HTMLElement\n): void {\n  ariaDescriptorMap.register(component, element);\n  // eslint-disable-next-line ember/no-runloop\n  scheduleOnce('afterRender', component, synchronizeDescriptors, component);\n}\n\nexport function unregisterAriaDescriptionElement(\n  component: AriaDescribedByComponent,\n  element: HTMLElement\n): void {\n  ariaDescriptorMap.unregister(component, element);\n  // eslint-disable-next-line ember/no-runloop\n  scheduleOnce('afterRender', component, synchronizeDescriptors, component);\n}\n"],"names":["AriaDescriptorMap","_elements","WeakMap","register","obj","element","elements","findOrCreateElementSet","add","unregister","delete","entries","Array","from","values","has","get","Set","set","ariaDescriptorMap","ariaDescribedBy","BaseComponent","EnhancedComponent","g","prototype","tracked","i","void 0","descriptors","__ARIA_DESCRIPTION_IDS__","args","extraAriaDescribedBy","concat","join","synchronizeDescriptors","component","isDestroying","isDestroyed","map","id","registerAriaDescriptionElement","scheduleOnce","unregisterAriaDescriptionElement"],"mappings":"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"}