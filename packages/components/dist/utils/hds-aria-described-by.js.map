{"version":3,"file":"hds-aria-described-by.js","sources":["../../src/utils/hds-aria-described-by.ts"],"sourcesContent":["/**\n * Copyright (c) HashiCorp, Inc.\n * SPDX-License-Identifier: MPL-2.0\n */\n\nimport { tracked } from '@glimmer/tracking';\nimport { scheduleOnce } from '@ember/runloop';\nimport type Component from '@glimmer/component';\nimport type { HdsFormFieldSignature } from '../components/hds/form/field/';\nimport type { HdsFormFieldsetSignature } from '../components/hds/form/fieldset/';\n\ntype ElementSet = Set<HTMLElement>;\n\nclass AriaDescriptorMap {\n  private _elements = new WeakMap<AriaDescribedByComponent, ElementSet>();\n\n  register(obj: AriaDescribedByComponent, element: HTMLElement): void {\n    const elements = this.findOrCreateElementSet(obj);\n    elements.add(element);\n  }\n\n  unregister(obj: AriaDescribedByComponent, element: HTMLElement): void {\n    const elements = this.findOrCreateElementSet(obj);\n    elements.delete(element);\n  }\n\n  entries(obj: AriaDescribedByComponent): HTMLElement[] {\n    const elements = this.findOrCreateElementSet(obj);\n    return Array.from(elements.values());\n  }\n\n  private findOrCreateElementSet(obj: AriaDescribedByComponent): ElementSet {\n    if (this._elements.has(obj)) {\n      return this._elements.get(obj) as ElementSet;\n    }\n\n    const elements: ElementSet = new Set();\n    this._elements.set(obj, elements);\n    return elements;\n  }\n}\n\nconst ariaDescriptorMap = new AriaDescriptorMap();\n\ntype AriaDescribedByArgs = HdsFormFieldSignature & HdsFormFieldsetSignature;\n\ninterface AriaDescribedByComponent extends Component<AriaDescribedByArgs> {\n  __ARIA_DESCRIPTION_IDS__?: string[];\n  ariaDescribedBy?: string;\n}\n\n// essentially a type that says we return a subclass of the given type T\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\ntype ClassOf<T> = new (owner: unknown, ...args: any[]) => T;\n\nexport function ariaDescribedBy(\n  BaseComponent: ClassOf<AriaDescribedByComponent>\n): ClassOf<AriaDescribedByComponent> {\n  class EnhancedComponent extends BaseComponent {\n    @tracked __ARIA_DESCRIPTION_IDS__: string[] = [];\n\n    get ariaDescribedBy(): string {\n      let descriptors = this.__ARIA_DESCRIPTION_IDS__;\n\n      if (this.args.extraAriaDescribedBy) {\n        descriptors = descriptors.concat(this.args.extraAriaDescribedBy);\n      }\n\n      return descriptors.join(' ');\n    }\n  }\n  return EnhancedComponent;\n}\n\nfunction synchronizeDescriptors(component: AriaDescribedByComponent): void {\n  if (component.isDestroying || component.isDestroyed) return;\n  const descriptors = ariaDescriptorMap.entries(component);\n  component.__ARIA_DESCRIPTION_IDS__ = descriptors.map(\n    (element): string => element.id\n  );\n}\n\nexport function registerAriaDescriptionElement(\n  component: AriaDescribedByComponent,\n  element: HTMLElement\n): void {\n  ariaDescriptorMap.register(component, element);\n  scheduleOnce('afterRender', component, synchronizeDescriptors, component);\n}\n\nexport function unregisterAriaDescriptionElement(\n  component: AriaDescribedByComponent,\n  element: HTMLElement\n): void {\n  ariaDescriptorMap.unregister(component, element);\n  scheduleOnce('afterRender', component, synchronizeDescriptors, component);\n}\n"],"names":["AriaDescriptorMap","constructor","_defineProperty","WeakMap","register","obj","element","elements","findOrCreateElementSet","add","unregister","delete","entries","Array","from","values","_elements","has","get","Set","set","ariaDescriptorMap","ariaDescribedBy","BaseComponent","_class","_descriptor","EnhancedComponent","args","_initializerDefineProperty","descriptors","__ARIA_DESCRIPTION_IDS__","extraAriaDescribedBy","concat","join","_applyDecoratedDescriptor","prototype","tracked","configurable","enumerable","writable","initializer","synchronizeDescriptors","component","isDestroying","isDestroyed","map","id","registerAriaDescriptionElement","scheduleOnce","unregisterAriaDescriptionElement"],"mappings":"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"}