{"version":3,"file":"hds-anchored-position.js","sources":["../../src/modifiers/hds-anchored-position.ts"],"sourcesContent":["/**\n * Copyright (c) HashiCorp, Inc.\n * SPDX-License-Identifier: MPL-2.0\n */\n\nimport { modifier } from 'ember-modifier';\nimport { assert } from '@ember/debug';\n\nimport {\n  autoUpdate,\n  computePosition,\n  offset,\n  flip,\n  shift,\n  limitShift,\n  autoPlacement,\n  arrow,\n  // ---\n  // this could be used in the future if we want to give consumers an option to hide the \"floating\" element when the \"anchor\" hides from the viewport\n  // see: https://floating-ui.com/docs/hide\n  // hide,\n  // ---\n  size,\n} from '@floating-ui/dom';\n\nimport type {\n  Placement,\n  Strategy,\n  OffsetOptions,\n  FlipOptions,\n  ShiftOptions,\n  AutoPlacementOptions,\n  ArrowOptions,\n  Middleware,\n} from '@floating-ui/dom';\n\nexport const DEFAULT_PLACEMENT = 'bottom';\nexport const PLACEMENTS: Placement[] = [\n  'top',\n  'top-start',\n  'top-end',\n  'right',\n  'right-start',\n  'right-end',\n  'bottom',\n  'bottom-start',\n  'bottom-end',\n  'left',\n  'left-start',\n  'left-end',\n];\n\n// share the same default value of \"padding\" for `flip/shift/autoPlacement` options\n// this refers to the minimum distance from the boundaries' edges (the viewport)\n// before the floating element changes its position (flips, shifts, or autoplace itself)\nconst DEFAULT_EDGE_DISTANCE = 8;\n\nexport type FloatingUIOptions = {\n  placement?: Placement;\n  strategy?: Strategy;\n  offsetOptions?: OffsetOptions;\n  flipOptions?: FlipOptions;\n  shiftOptions?: ShiftOptions;\n  autoPlacementOptions?: AutoPlacementOptions;\n  middlewareExtra?: Middleware[];\n  enableCollisionDetection?: boolean | 'shift' | 'flip' | 'auto';\n  arrowElement?: ArrowOptions['element'];\n  arrowPadding?: ArrowOptions['padding'];\n  matchToggleWidth?: boolean;\n};\n\n// we use this function to process all the options provided to the modifier in a single place,\n// in relation to the Floating UI APIs, and keep the modifier code more clean/simple\nexport const getFloatingUIOptions = (\n  options: FloatingUIOptions\n): {\n  placement: Placement;\n  strategy: Strategy;\n  middleware: Middleware[];\n} => {\n  const {\n    placement = DEFAULT_PLACEMENT,\n    strategy = 'absolute', // we don't need to use `fixed` if we use the Popover API for the \"floating\" element (it puts the element in the `top-layer`)\n    offsetOptions,\n    flipOptions = { padding: DEFAULT_EDGE_DISTANCE },\n    shiftOptions = { padding: DEFAULT_EDGE_DISTANCE, limiter: limitShift() },\n    autoPlacementOptions = { padding: DEFAULT_EDGE_DISTANCE },\n    middlewareExtra = [],\n    enableCollisionDetection,\n    arrowElement,\n    arrowPadding,\n    matchToggleWidth,\n  } = options;\n\n  // we build dynamically the list of middleware functions to invoke, depending on the options provided\n\n  const middleware = [];\n\n  // https://floating-ui.com/docs/offset\n  middleware.push(offset(offsetOptions));\n\n  // https://floating-ui.com/docs/flip\n  // https://floating-ui.com/docs/shift\n  // https://floating-ui.com/docs/autoPlacement\n  if (\n    enableCollisionDetection === true ||\n    enableCollisionDetection === 'flip'\n  ) {\n    middleware.push(flip(flipOptions));\n  }\n  if (\n    enableCollisionDetection === true ||\n    enableCollisionDetection === 'shift'\n  ) {\n    middleware.push(shift(shiftOptions));\n  }\n  if (enableCollisionDetection === 'auto') {\n    middleware.push(autoPlacement(autoPlacementOptions));\n  }\n\n  // https://floating-ui.com/docs/arrow\n  if (arrowElement) {\n    middleware.push(\n      arrow({\n        element: arrowElement,\n        padding: arrowPadding ?? 0,\n      })\n    );\n  }\n\n  // https://floating-ui.com/docs/size#match-reference-width\n  if (matchToggleWidth) {\n    middleware.push(\n      size({\n        apply({ rects, elements }) {\n          Object.assign(elements.floating.style, {\n            width: `${rects.reference.width}px`,\n          });\n        },\n      })\n    );\n  }\n\n  middleware.push(...middlewareExtra);\n\n  return {\n    placement,\n    strategy,\n    middleware,\n  };\n};\n\nexport interface HdsAnchoredPositionSignature {\n  Element: HTMLElement;\n  Args: {\n    Positional: [HTMLElement | SVGElement];\n    Named: FloatingUIOptions & { arrowSelector?: string };\n  };\n}\n\n// Notice: we use a function-based modifier here instead of a class-based one\n// because it's quite simple in its logic, and doesn't require injecting services\n// see: https://github.com/ember-modifier/ember-modifier#function-based-modifiers\n\nexport default modifier<HdsAnchoredPositionSignature>(\n  (element, positional, named = {}) => {\n    // the element that \"floats\" next to the \"anchor\" (whose position is calculated in relation to the anchor)\n    // notice: this is the element the Ember modifier is attached to\n    const _floatingElement = element;\n\n    // the element that acts as an \"anchor\" for the \"floating\" element\n    // it can be a DOM (string) selector or a DOM element\n    // notice: it's expressed as \"positional\" argument (array of arguments) for the modifier\n    const _anchorTarget = positional[0];\n    const _anchorElement =\n      typeof _anchorTarget === 'string'\n        ? document.querySelector(_anchorTarget)\n        : _anchorTarget;\n\n    assert(\n      '`hds-anchored-position` modifier - the provided \"anchoring\" element is not defined correctly',\n      _anchorElement instanceof HTMLElement ||\n        _anchorElement instanceof SVGElement\n    );\n\n    // the \"arrow\" element (optional) associated with the \"floating\" element\n    // it can be a DOM selector (string) or a DOM element\n    // notice: it's declared inside the \"named\" argument (object) for the modifier\n    // but we need to extract it also here so it can be used to assign inline styles to it\n    let arrowElement: HTMLElement | SVGElement | undefined;\n\n    if (named.arrowElement) {\n      assert(\n        '`hds-anchored-position` modifier - the `element` provided for the \"arrow\" element is not a valid DOM node',\n        named.arrowElement instanceof HTMLElement ||\n          named.arrowElement instanceof SVGElement\n      );\n\n      arrowElement = named.arrowElement;\n    } else if (named.arrowSelector) {\n      assert(\n        '`hds-anchored-position` modifier - the `selector` provided for the \"arrow\" element must be a string',\n        typeof named.arrowSelector === 'string'\n      );\n\n      const selectedArrowElement = document.querySelector(named.arrowSelector);\n      if (selectedArrowElement instanceof HTMLElement) {\n        arrowElement = selectedArrowElement;\n      } else {\n        assert(\n          '`hds-anchored-position` modifier - the `selector` provided for the \"arrow\" element is not a valid DOM selector'\n        );\n      }\n    }\n\n    // the Floating UI \"options\" to apply to the \"floating\" element\n    // notice: we spread the `named` argument and override its `arrowElement` value instead of setting it directly because Ember complains that modifier's arguments must be immutable\n    const floatingOptions = getFloatingUIOptions({ ...named, arrowElement });\n\n    const computeFloatingPosition = async () => {\n      // important to know: `computePosition()` is not stateful, it only positions the \"floating\" element once\n      // see: https://floating-ui.com/docs/computePosition\n      const state = await computePosition(\n        _anchorElement,\n        _floatingElement,\n        floatingOptions\n      );\n\n      const { x, y, placement, strategy, middlewareData } = state;\n\n      Object.assign(_floatingElement.style, {\n        position: strategy,\n        top: `${y}px`,\n        left: `${x}px`,\n        // TODO? commenting this for now, will need to make this conditional to some argument (and understand how this relates to the `@height` argument)\n        // maxHeight: `${middlewareData.size.availableHeight - 10}px`,\n      });\n\n      if (arrowElement && middlewareData.arrow) {\n        // we assign a \"data\" attribute to the \"arrow\" element so we can use CSS (in the consuming components) to position/rotate it accordingly and we avoid calculating at runtime values that technically we already know\n        // (similar to what Tippy.js does: https://github.com/atomiks/tippyjs/blob/master/src/scss/svg-arrow.scss)\n        // IMPORTANT: floating-ui assumes the \"arrow\" container is square!\n        arrowElement.setAttribute(\n          'data-hds-anchored-arrow-placement',\n          placement\n        );\n\n        // we set `x` or `y` value (depends on the position of the arrow in relation to the \"floating\" element placement)\n        // see: https://floating-ui.com/docs/arrow#usage\n        Object.assign(arrowElement.style, {\n          left:\n            middlewareData.arrow.x != null ? `${middlewareData.arrow.x}px` : '',\n          top:\n            middlewareData.arrow.y != null ? `${middlewareData.arrow.y}px` : '',\n        });\n      }\n    };\n\n    // the `autoUpdate` function automatically updates the position of the floating element when necessary.\n    // it should only be called when the floating element is mounted on the DOM or visible on the screen.\n    // it returns a \"cleanup\" function that should be invoked when the floating element is removed from the DOM or hidden from the screen.\n    // see: https://floating-ui.com/docs/autoUpdate\n    const cleanupFloatingUI = autoUpdate(\n      _anchorElement,\n      _floatingElement,\n      computeFloatingPosition\n    );\n\n    // this (teardown) function is run when the element is removed from the DOM\n    return (): void => {\n      cleanupFloatingUI();\n    };\n  }\n);\n"],"names":["DEFAULT_PLACEMENT","PLACEMENTS","DEFAULT_EDGE_DISTANCE","getFloatingUIOptions","options","placement","strategy","offsetOptions","flipOptions","padding","shiftOptions","limiter","limitShift","autoPlacementOptions","middlewareExtra","enableCollisionDetection","arrowElement","arrowPadding","matchToggleWidth","middleware","push","offset","flip","shift","autoPlacement","arrow","element","size","apply","rects","elements","Object","assign","floating","style","width","reference","modifier","positional","named","_floatingElement","_anchorTarget","_anchorElement","document","querySelector","assert","HTMLElement","SVGElement","arrowSelector","selectedArrowElement","floatingOptions","computeFloatingPosition","state","computePosition","x","y","middlewareData","position","top","left","setAttribute","cleanupFloatingUI","autoUpdate"],"mappings":"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"}