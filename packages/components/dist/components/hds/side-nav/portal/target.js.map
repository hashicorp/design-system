{"version":3,"file":"target.js","sources":["../../../../../src/components/hds/side-nav/portal/target.ts"],"sourcesContent":["/**\n * Copyright (c) HashiCorp, Inc.\n * SPDX-License-Identifier: MPL-2.0\n */\n\nimport Component from '@glimmer/component';\nimport { inject as service } from '@ember/service';\nimport { tracked } from '@glimmer/tracking';\nimport { action } from '@ember/object';\nimport { macroCondition, isTesting } from '@embroider/macros';\n\nimport type { HdsSideNavPortalSignature } from './index';\n\n// import { PortalTargetSignature } from 'ember-stargate/components/portal-target';\nexport interface PortalTargetSignature {\n  Element: HTMLDivElement;\n  Args: {\n    name: string;\n    multiple?: boolean;\n    onChange?: (count: number) => void;\n  };\n  Blocks: {\n    default: [number];\n  };\n}\n\nimport type { Registry as Services } from '@ember/service';\n\nexport interface HdsSideNavPortalTargetSignature {\n  Args: PortalTargetSignature['Args'] & {\n    targetName?: HdsSideNavPortalSignature['Args']['targetName'];\n  };\n  Element: HTMLDivElement;\n}\n\nexport default class HdsSideNavPortalTarget extends Component<HdsSideNavPortalTargetSignature> {\n  @service router!: Services['router'];\n\n  @tracked numSubnavs = 0;\n  @tracked lastPanelEl: Element | undefined;\n\n  static get prefersReducedMotionOverride(): boolean {\n    return macroCondition(isTesting()) ? true : false;\n  }\n\n  prefersReducedMotionMQ = window.matchMedia(\n    '(prefers-reduced-motion: reduce)'\n  );\n\n  get prefersReducedMotion(): boolean {\n    return (\n      HdsSideNavPortalTarget.prefersReducedMotionOverride ||\n      (this.prefersReducedMotionMQ && this.prefersReducedMotionMQ.matches)\n    );\n  }\n\n  @action\n  panelsChanged(portalCount: number): void {\n    this.numSubnavs = portalCount;\n  }\n\n  @action\n  didUpdateSubnav(element: HTMLElement, [count]: [number]): void {\n    this.animateSubnav(element, [count]);\n  }\n\n  @action\n  animateSubnav(element: HTMLElement, [count]: [number]): void {\n    /*\n     * Here is what the layout looks like for this setup\n     *\n\n                                    SideNav\n                                    +----------------------+\n                                    | +------------------+ |\n                                    | |    (\"header\")    | |\n                                    | +------------------+ |\n                                    |                      |\n                                    | +------------------+ |\n                                    | |    (\"body\")      | |\n        (PortalTarget)              | |                  | |\n        +----------------------------------------------+ | |\n        | +----------+  +----------+  |  +----------+  | | |\n        | | (Portal) |  | (Portal) |     | (Portal) |  | | |\n        | |          |  |          |  |  |          |  | | |\n        | |  hidden  |  |  hidden  |     | *active* |  | | |\n        | |   panel  |  |   panel  |  |  |   panel  |  | | |\n        | |          |  |          |     |          |  | | |\n        | |          |  |          |  |  |          |  | | |\n        | |          |  |          |     |          |  | | |\n        | |          |  |          |  |  |          |  | | |\n        | |          |  |          |     |          |  | | |\n        | |          |  |          |  |  |          |  | | |\n        | |          |  |          |     |          |  | | |\n        | +----------+  +----------+  |  +----------+  | | |\n        +----------------------------------------------+ | |\n                                    | |                  | |\n                                    | +------------------+ |\n                                    |                      |\n                                    | +------------------+ |\n                                    | |    (\"footer\")    | |\n                                    | +------------------+ |\n                                    +----------------------+\n\n     *\n     * every time `HcAppFrame::SideNav::Portal` renders, it contains a portaled \"panel\"\n     * that is rendered into the `hds-side-nav__content-panels` (inside the PortalTarget).\n     *\n     * Rendering or unrendering other `HcAppFrame::SideNav::Portal`s triggers the number of\n     * subnavs to change (via `numSubnavs`), so this function runs and slides\n     * `hds-side-nav__content-panels` left or right using the `element.animate` api.\n     *\n     * */\n\n    const activeIndex = count - 1;\n    const targetElement = element;\n    const { prefersReducedMotion } = this;\n\n    const styles = getComputedStyle(targetElement);\n    const columnWidth = styles.getPropertyValue(\n      '--hds-app-sidenav-width-expanded'\n    );\n    const slideDuration = prefersReducedMotion ? 0 : 150;\n    let fadeDuration = prefersReducedMotion ? 0 : 175;\n    let fadeDelay = prefersReducedMotion ? 0 : 50;\n\n    // slide entire parent panel\n    const start = styles.transform;\n    const end = `translateX(-${activeIndex * parseInt(columnWidth, 10)}px)`;\n    const anim = targetElement.animate(\n      [{ transform: start }, { transform: end }],\n      {\n        duration: slideDuration,\n        easing: 'cubic-bezier(0.65, 0, 0.35, 1)',\n        fill: 'forwards',\n      }\n    );\n\n    anim.finished.then((): void => {\n      // uncomment this if we need/want to scroll the element to the top\n      // targetElement.scrollIntoView(true);\n      if (activeIndex > 0) {\n        const allPrev = Array.from(targetElement.children).slice(\n          0,\n          activeIndex\n        ) as HTMLElement[];\n        for (const ele of allPrev) {\n          ele.ariaHidden = 'true';\n          ele.style.setProperty('visibility', 'hidden');\n          ele.style.setProperty('opacity', '0');\n        }\n      }\n      // Notice: we don't add the styles by default because it writes a `style` attribute to the element and it causes an additional re-render\n      if (macroCondition(isTesting())) {\n        // Check the visibility of the element before attempting to commitStyles.\n        if (targetElement.offsetParent !== null) {\n          anim.commitStyles();\n        }\n      }\n    });\n\n    // fade in next panel\n    const nextPanelEl = targetElement.children[activeIndex] as HTMLElement;\n\n    // get reference to last child panel\n    const lastPanelEl = targetElement.children[\n      targetElement.children.length - 1\n    ] as HTMLElement;\n\n    if (nextPanelEl) {\n      nextPanelEl.ariaHidden = 'false';\n      nextPanelEl.style.setProperty('visibility', 'visible');\n      // this eliminates a flicker if there's only one subnav rendering or if we\n      // already just rendered this panel.\n      if (this.lastPanelEl) {\n        if (activeIndex === 0 || nextPanelEl.isSameNode(this.lastPanelEl)) {\n          fadeDelay = 0;\n          fadeDuration = 0;\n        }\n      }\n\n      // remember the last panel\n      this.lastPanelEl = lastPanelEl;\n\n      nextPanelEl.animate([{ opacity: '0' }, { opacity: '1' }], {\n        delay: fadeDelay,\n        duration: fadeDuration,\n        fill: 'forwards',\n      });\n    }\n  }\n}\n"],"names":["HdsSideNavPortalTarget","Component","g","prototype","service","i","void 0","tracked","prefersReducedMotionOverride","macroCondition","isTesting","prefersReducedMotionMQ","window","matchMedia","prefersReducedMotion","matches","panelsChanged","portalCount","numSubnavs","n","action","didUpdateSubnav","element","count","animateSubnav","activeIndex","targetElement","styles","getComputedStyle","columnWidth","getPropertyValue","slideDuration","fadeDuration","fadeDelay","start","transform","end","parseInt","anim","animate","duration","easing","fill","finished","then","allPrev","Array","from","children","slice","ele","ariaHidden","style","setProperty","offsetParent","commitStyles","nextPanelEl","lastPanelEl","length","isSameNode","opacity","delay","setComponentTemplate","TEMPLATE"],"mappings":"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"}