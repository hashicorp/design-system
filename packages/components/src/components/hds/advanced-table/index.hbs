{{!
  Copyright IBM Corp. 2021, 2025
  SPDX-License-Identifier: MPL-2.0
}}

<div class="hds-advanced-table__actions-container-wrapper">
  {{#if (has-block "actions")}}
    <div class="hds-advanced-table__actions">
      {{yield (hash FilterBar=(component "hds/filter-bar")) to="actions"}}
    </div>
  {{/if}}

  <div
    class="hds-advanced-table__container
      {{(if this.isStickyHeaderPinned 'hds-advanced-table__container--header-is-pinned')}}"
    ...attributes
  >
    {{! Caption }}
    <div id={{this._captionId}} class="sr-only hds-advanced-table__caption" aria-live="polite">
      {{@caption}}
      {{this.sortedMessageText}}
      {{this.reorderedMessageText}}
    </div>

    <Hds::AdvancedTable::ColumnManager
      @columns={{@columns}}
      @columnOrder={{@columnOrder}}
      @hasReorderableColumns={{@hasReorderableColumns}}
      @hasStickyFirstColumn={{@hasStickyFirstColumn}}
      @isSelectable={{@isSelectable}}
      @onColumnReorder={{this._onColumnReorder}}
      as |CM|
    >

      {{! Grid }}
      <div
        class={{this.classNames}}
        role="grid"
        aria-describedby={{this._captionId}}
        {{style
          grid-template-columns=CM.gridTemplateColumns
          --hds-advanced-table-sticky-column-offset=this.stickyColumnOffset
          max-height=@maxHeight
        }}
        {{this._setUpScrollWrapper}}
        {{CM.syncColumnOrder CM.columns @columnOrder}}
        {{CM.syncWidthValues}}
      >
        {{! Header }}
        <div
          class={{this.theadClassNames}}
          role="rowgroup"
          {{this._setUpThead}}
          {{on "dragleave" (fn CM.setReorderHoveredColumnKey null)}}
        >
          <Hds::AdvancedTable::Tr
            @selectionScope="col"
            @onClickSortBySelected={{if @selectableColumnKey (fn this.setSortBy @selectableColumnKey)}}
            @sortBySelectedOrder={{if (eq this.sortBy @selectableColumnKey) this.sortOrder}}
            @isSelectable={{this.isSelectable}}
            @onSelectionChange={{this.onSelectionAllChange}}
            @didInsert={{this.didInsertSelectAllCheckbox}}
            @willDestroy={{this.willDestroySelectAllCheckbox}}
            @selectionAriaLabelSuffix="all rows"
            @hasStickyColumn={{this.hasStickyFirstColumn}}
            @isStickyColumnPinned={{this.isStickyColumnPinned}}
          >
            {{#each CM.orderedColumns as |column|}}
              <Hds::AdvancedTable::Th
                @align={{column.align}}
                @column={{column}}
                @draggedColumnKey={{CM.draggedColumnKey}}
                @firstColumnKey={{CM.firstColumnKey}}
                @hasReorderableColumns={{@hasReorderableColumns}}
                @hasResizableColumns={{@hasResizableColumns}}
                @hasSelectableRows={{this.isSelectable}}
                @hasStickyFirstColumn={{this.hasStickyFirstColumn}}
                @isStickyColumn={{if
                  (and (eq column.key CM.firstColumnKey) (not-eq this.hasStickyFirstColumn undefined))
                  this.hasStickyFirstColumn
                  undefined
                }}
                @isStickyColumnPinned={{this.isStickyColumnPinned}}
                @lastColumnKey={{CM.lastColumnKey}}
                @reorderHoveredColumnKey={{CM.reorderHoveredColumnKey}}
                @draggedColumnSiblingColumnKeys={{if CM.draggedColumnKey (CM.getSiblingColumnKeys CM.draggedColumnKey)}}
                @siblingColumnKeys={{CM.getSiblingColumnKeys column.key}}
                @tableHeight={{this._tableHeight}}
                @tooltip={{column.tooltip}}
                @hasExpandAllButton={{this.hasRowsWithChildren}}
                @isExpanded={{this.isAllExpanded}}
                @isExpandable={{column.isExpandable}}
                @sortOrder={{if (eq column.key this.sortBy) this.sortOrder}}
                @onApplyTransientWidth={{CM.applyTransientWidth}}
                @onClickSort={{if column.isSortable (fn this.setSortBy column.key)}}
                @onClickToggle={{this.toggleExpandAll}}
                @onColumnResize={{@onColumnResize}}
                @onGetAppliedWidth={{CM.getAppliedWidth}}
                @onGetColumnByKey={{CM.getColumnByKey}}
                @onMoveColumnToTerminalPosition={{CM.moveColumnToTerminalPosition}}
                @onPinFirstColumn={{this._onPinFirstColumn}}
                @onReorderDrop={{CM.moveColumnToDropTarget}}
                @onRestoreColumnWidth={{CM.restoreColumnWidth}}
                @onResetTransientColumnWidths={{CM.resetTransientColumnWidths}}
                @onSetDraggedColumnKey={{CM.setDraggedColumnKey}}
                @onSetReorderHoveredColumnKey={{CM.setReorderHoveredColumnKey}}
                @onSetTransientColumnWidth={{CM.setTransientColumnWidth}}
                @onSetTransientColumnWidths={{CM.setTransientColumnWidths}}
                @onStepColumn={{CM.stepColumn}}
                @onUpdateResizeDebt={{CM.updateResizeDebt}}
                {{CM.syncThElements column.key}}
              >
                {{column.label}}
              </Hds::AdvancedTable::Th>
            {{/each}}
          </Hds::AdvancedTable::Tr>

          {{#if this.showScrollIndicatorTop}}
            <div class="hds-advanced-table__scroll-indicator hds-advanced-table__scroll-indicator-top" />
          {{/if}}
        </div>

        {{! Body }}
        <Hds::AdvancedTable::Body
          @childrenKey={{this.childrenKey}}
          @expandedRowIds={{this.expandedRowIds}}
          {{! @glint-expect-error: [HDS-4380](https://hashicorp.atlassian.net/browse/HDS-4380) }}
          @sortedModel={{sort-by this.sortCriteria @model}}
          as |B|
        >
          {{#each B.rows key="id" as |row index|}}
            {{#let (and (not this.hasRowsWithChildren) (not row.hasChildren)) as |isSimpleRow|}}
              {{yield
                (hash
                  Tr=(component
                    "hds/advanced-table/tr"
                    columnOrder=CM.columnOrder
                    data=row.source
                    depth=row.depth
                    isParentRow=row.hasChildren
                    isLastRow=(and (eq row.id B.lastVisibleRowId) (not-eq B.lastVisibleRowId undefined))
                    displayRow=row.isVisible
                    selectionScope=(if isSimpleRow "row")
                    isSelectable=(if isSimpleRow this.isSelectable)
                    onSelectionChange=(if isSimpleRow this.onSelectionRowChange)
                    didInsert=(if isSimpleRow this.didInsertRowCheckbox)
                    willDestroy=(if isSimpleRow this.willDestroyRowCheckbox)
                    hasStickyColumn=this.hasStickyFirstColumn
                    isStickyColumnPinned=this.isStickyColumnPinned
                  )
                  Th=(component
                    "hds/advanced-table/th"
                    isExpandable=row.hasChildren
                    isExpanded=row.isExpanded
                    onClickToggle=(fn this.toggleRow row.id)
                    depth=row.depth
                    scope="row"
                    newLabel=row.id
                    isStickyColumn=this.hasStickyFirstColumn
                    isStickyColumnPinned=this.isStickyColumnPinned
                  )
                  Td=(component "hds/advanced-table/td" align=@align)
                  data=row.source
                  rowIndex=index
                  isOpen=row.isExpanded
                )
                to="body"
              }}
            {{/let}}
          {{/each}}
        </Hds::AdvancedTable::Body>
      </div>
    </Hds::AdvancedTable::ColumnManager>

    {{! Empty state }}
    {{#if this.isEmpty}}
      <div class="hds-advanced-table__empty-state">
        {{#if (has-block "emptyState")}}
          {{yield to="emptyState"}}
        {{else}}
          <Hds::ApplicationState as |A|>
            <A.Header @title={{hds-t "hds.components.advanced-table.empty-state.title" default="No data available"}} />
            <A.Body
              @text={{hds-t
                "hds.components.advanced-table.empty-state.description"
                default="There is currently no data to display in the table."
              }}
            />
          </Hds::ApplicationState>
        {{/if}}
      </div>
    {{/if}}

    {{#if this.showScrollIndicatorLeft}}
      <div
        class="hds-advanced-table__scroll-indicator hds-advanced-table__scroll-indicator-left"
        {{style height=this.scrollIndicatorDimensions.height left=this.scrollIndicatorDimensions.left}}
      />
    {{/if}}

    {{#if this.showScrollIndicatorRight}}
      <div
        class="hds-advanced-table__scroll-indicator hds-advanced-table__scroll-indicator-right"
        {{style height=this.scrollIndicatorDimensions.height right=this.scrollIndicatorDimensions.right}}
      />
    {{/if}}

    {{#if this.showScrollIndicatorBottom}}
      <div
        class="hds-advanced-table__scroll-indicator hds-advanced-table__scroll-indicator-bottom"
        {{style bottom=this.scrollIndicatorDimensions.bottom width=this.scrollIndicatorDimensions.width}}
      />
    {{/if}}
  </div>
</div>