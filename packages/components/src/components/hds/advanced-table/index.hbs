{{!
  Copyright (c) HashiCorp, Inc.
  SPDX-License-Identifier: MPL-2.0
}}

<div
  class={{this.classNames}}
  ...attributes
  role="grid"
  aria-describedby={{this._captionId}}
  {{style grid-template-columns=this.gridTemplateColumns}}
  {{this._setUpObservers}}
>
  {{! Caption }}
  <div id={{this._captionId}} class="sr-only hds-advanced-table__caption" aria-live="polite">
    {{@caption}}
    {{this.sortedMessageText}}
  </div>

  {{! Head }}
  <div class="hds-advanced-table__thead {{if @hasStickyHeader 'hds-advanced-table__thead--sticky'}}" role="rowgroup">
    <Hds::AdvancedTable::Tr
      @selectionScope="col"
      @onClickSortBySelected={{if @selectableColumnKey (fn this.setSortBy @selectableColumnKey)}}
      @sortBySelectedOrder={{if (eq this._sortBy @selectableColumnKey) this._sortOrder}}
      @isSelectable={{this.isSelectable}}
      @onSelectionChange={{this.onSelectionAllChange}}
      @didInsert={{this.didInsertSelectAllCheckbox}}
      @willDestroy={{this.willDestroySelectAllCheckbox}}
      @selectionAriaLabelSuffix="all rows"
    >
      {{#each @columns as |column|}}
        {{#if column.isSortable}}
          <Hds::AdvancedTable::ThSort
            @sortOrder={{if (eq column.key this._sortBy) this._sortOrder}}
            @onClickSort={{fn this.setSortBy column.key}}
            @align={{column.align}}
            @tooltip={{column.tooltip}}
          >
            {{column.label}}
          </Hds::AdvancedTable::ThSort>
        {{else}}
          <Hds::AdvancedTable::Th
            @align={{column.align}}
            @tooltip={{column.tooltip}}
            @isVisuallyHidden={{column.isVisuallyHidden}}
            @isExpandable={{column.isExpandable}}
            @onClickToggle={{this.onExpandAllClick}}
            @isExpanded={{this._tableModel.openState}}
            @hasExpandAllButton={{this.hasNestedRows}}
          >{{column.label}}</Hds::AdvancedTable::Th>
        {{/if}}
      {{/each}}
    </Hds::AdvancedTable::Tr>
  </div>

  {{! Body }}
  <div class="hds-advanced-table__tbody" role="rowgroup">
    {{! ----------------------------------------------------------------------------------------
        IMPORTANT: we loop on the `model` array and for each record
        we yield the Tr/Td/Th elements _and_ the record itself as `data`
        this means the consumer will *have to* use the `data` key to access it in their template
      -------------------------------------------------------------------------------------------- }}
    {{#each (sort-by this.getSortCriteria this._tableModel.rows) key=this.identityKey as |record index|}}
      {{#if this.hasNestedRows}}
        <Hds::AdvancedTable::ExpandableTrGroup @record={{record}} @rowIndex={{index}} as |T|>
          {{yield
            (hash
              Tr=(component
                "hds/advanced-table/tr"
                depth=T.depth
                isLastRow=(eq this._tableModel.lastVisibleRow.id T.data.id)
                isParentRow=T.isExpandable
              )
              Th=(component
                "hds/advanced-table/th"
                depth=T.depth
                isExpandable=T.isExpandable
                isExpanded=T.isOpen
                isOpen=T.isOpen
                newLabel=T.id
                parentId=T.parentId
                scope="row"
                onClickToggle=T.onClickToggle
              )
              Td=(component "hds/advanced-table/td" align=@align)
              data=T.data
              isOpen=T.isOpen
              rowIndex=T.rowIndex
            )
            to="body"
          }}
        </Hds::AdvancedTable::ExpandableTrGroup>
      {{else}}
        {{yield
          (hash
            Tr=(component
              "hds/advanced-table/tr"
              isLastRow=(eq this._tableModel.lastVisibleRow.id record.id)
              isSelectable=this.isSelectable
              selectionAriaLabelSuffix=@selectionAriaLabelSuffix
              selectionScope="row"
              didInsert=this.didInsertRowCheckbox
              onSelectionChange=this.onSelectionRowChange
              willDestroy=this.willDestroyRowCheckbox
            )
            Th=(component "hds/advanced-table/th" scope="row")
            Td=(component "hds/advanced-table/td" align=@align)
            data=record
            rowIndex=index
          )
          to="body"
        }}
      {{/if}}
    {{/each}}
  </div>
</div>